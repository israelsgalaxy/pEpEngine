include:
  - '.gitlab-ci-files/common-prepare.yml'

stages:
  - deps
  - build
  - packages


# Debian

debian10:build:
  extends: .make_in_docker
  stage: build
  variables:
    MAKE_TARGET: "build"
    CI_DISTRO_TARGET: "debian10"
    DEBIAN_FRONTEND: "noninteractive"
  rules:
    - if: '$CI_COMMIT_TAG  !~ /^Release_[0-9]+\.[0-9]+\.[0-9]+$/'

debian10:tagged-build:
  extends: .make_in_docker
  stage: build
  variables:
    MAKE_TARGET: "build"
    CI_DISTRO_TARGET: "debian10"
    DEBIAN_FRONTEND: "noninteractive"
    TAGGED_BUILD: "true"
  rules:
    - if: '$CI_COMMIT_TAG  =~ /^Release_[0-9]+\.[0-9]+\.[0-9]+$/'

# CentOS

centos8:deps:
  extends: .make_in_docker
  stage: deps
  variables:
    MAKE_TARGET: "deps"
    CI_DISTRO_TARGET: "centos8"
  rules:
    - changes:
        - DEPENDENCIES


centos8:build:
  extends: .make_in_docker
  stage: build
  variables:
    MAKE_TARGET: "build"
    CI_DISTRO_TARGET: "centos8"
  rules:
    - if: '$CI_COMMIT_TAG  !~ /^Release_[0-9]+\.[0-9]+\.[0-9]+$/'

centos8:tagged-build:
  extends: .make_in_docker
  stage: build
  variables:
    MAKE_TARGET: "build"
    CI_DISTRO_TARGET: "centos8"
    TAGGED_BUILD: "true"
  rules:
    - if: '$CI_COMMIT_TAG  =~ /^Release_[0-9]+\.[0-9]+\.[0-9]+$/'

centos8:rpm:
  extends: .make_in_docker
  stage: packages
  needs: ["centos8:build"]
  variables:
    MAKE_TARGET: "rpm"
    CI_DISTRO_TARGET: "centos8"
  rules:
    - if: '$CI_COMMIT_TAG  !~ /^Release_[0-9]+\.[0-9]+\.[0-9]+$/'


centos8:rpm:tagged-build:
  extends: .upload_pkg
  stage: packages
  needs: ["centos8:tagged-build"]
  variables:
    MAKE_TARGET: "rpm"
    CI_DISTRO_TARGET: "centos8"
    TAGGED_BUILD: "true"
  rules:
    - if: '$CI_COMMIT_TAG  =~ /^Release_[0-9]+\.[0-9]+\.[0-9]+$/'
