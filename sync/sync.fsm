// DeviceGroup protocol for p≡p

// Copyleft (c) 2016, p≡p foundation

// Written by Volker Birk

include ./fsm.yml2

protocol DeviceGroup {
    // all messages have a timestamp, time out and are removed after timeout

    fsm DeviceState {
        on Init {
            if (storedGroupKeys)
                go Grouped;
            go Sole;
        }

        state Sole {
            on KeyGen
                do sendBeacon;
            on CannotDecrypt
                do sendBeacon;  // cry, baby
            on Beacon(identity partner) // this event will not happen for already
                                        // rejected partners
                do sendHandshakeRequest(partner);
            on HandshakeRequest(identity partner) {
                do sendHandshakeRequest(partner);
                go HandshakingSole(partner);
            }
        }

        state HandshakingSole(identity partner) {
            on Init
                do showHandshake(partner);
            on HandshakeRejected(identity partner) {
                do reject(partner);             // sends Reject to partner and
                                                // stores rejection of partner
                go Sole;
            }
            on HandshakeAccepted(partner) {
                if keyElectionWon(partner) {    // an already existing group
                                                // always wins
                    storeOwnKeysAsGroupKeys;
                    sendGroupKeys(partner);
                    go Grouped;
                }
                go WaitForGroupKeys(partner);
            }
        }
    
        state WaitForGroupKeys(identity partner) {
            on ReceiveGroupKeys(identity partner) {
                storeGroupKeys(partner);
                go Grouped;
            }
            on Cancel go Sole;
            on Reject(identity partner) {
                do reject(partner);
                go Sole;
            }
        }

        state Grouped {
            on KeyGen
                do sendOwnKeys; // always send all keys
            on HandshakeRequest(identity partner) {
                do sendHandshakeRequest(partner);
                do showHandshake(partner);
            }
            on HandshakeRejected(identity partner)
                do reject(partner);
            on HandshakeAccepted(identity partner)
                do sendGroupKeys(partner);
            on Reject(identity partner)
                do reject partner;
        }
    }
}

